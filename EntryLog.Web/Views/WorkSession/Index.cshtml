@{
    Layout = "_MainLayout";
    ViewBag.Title = "Sesiones de Trabajo";
}

@model EntryLog.Business.Pagination.PaginatedResult<GetWorkSessionDTO>

<link href="~/css/work.index.css" rel="stylesheet" />

@{
    bool isFaceIdActive = (bool)ViewBag.IsFaceIdActive;
    bool hasActiveSession = (bool)ViewBag.HasActiveSession;
}

<div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
    <div>
        <h3 class="fw-bold mb-3">Sesiones</h3>
    </div>

    <div id="open-work-session-content" class="ms-md-auto py-2 py-md-0">
        @if (isFaceIdActive && !hasActiveSession)
        {
            <div id="add-work-session-btn">
                <button onclick="openRecognitionModal('open')" class="btn btn-primary btn-round">Agregar sesión</button>
            </div>
        }
    </div>
</div>

@if (!isFaceIdActive)
{
    <div id="faceid-no-configured-alert" class="col-md-12">
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <h6>
                <a href="/empleado/faceid" class="btn-link"><b>Face ID</b></a>
                no ha sido configurado y es requerido para poder gestionar las sesiones de trabajo
            </h6>

            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
}

@if (isFaceIdActive && Model.ResultsCount == 0)
{
    <div id="no-sessions-alert" class="col-md-12">
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <h6>Cree una sesión para comenzar</h6>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
}

@{
    const string STATUS_COMPLETED = "Completed";
    const string STATUS_IN_PROGRESS = "InProgress";
    const string STATUS_COMPLETED_NAME = "Completada";
    const string STATUS_IN_PROGRESS_NAME = "En Progreso";
}

<div id="work-sessions" class="row px-3">

    @foreach (var item in Model.Results ?? [])
    {
        string statusIcon = "";
        string statusName = "";

        switch (item.Status)
        {
            case STATUS_COMPLETED:
                statusIcon = "fa-check-circle text-success";
                statusName = STATUS_COMPLETED_NAME;
                break;

            case STATUS_IN_PROGRESS:
                statusIcon = "fa-spinner text-primary";
                statusName = STATUS_IN_PROGRESS_NAME;
                break;
            default:
                break;
        }
        <div class="card">
            <div class="card-header">
                <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row">
                    <div id="status-fields-@item.Id">
                        <i class="fas fa-1x @statusIcon"></i>
                        @statusName
                    </div>
                    <div class="ms-md-auto py-2 py-md-0">
                        <button onclick="showSessionDetail('@item.Id')" class="btn btn-label-info btn-round btn-sm">
                            <span class="btn-label">
                                <i class="fa fa-eye"></i>
                            </span>
                            Detalle
                        </button>
                        @if (item.Status == STATUS_IN_PROGRESS)
                        {
                            <button id="close-session-@item.Id" onclick="openRecognitionModal('close')" class="btn btn-label-success btn-round btn-sm">
                                <span class="btn-label">
                                    <i class="fa fa-arrow-circle-right"></i>
                                </span>
                                Salir
                            </button>
                        }
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-3">
                        <h6 class="fw-bolder">Entrada:</h6>
                        <p class="card-text">@item.CheckIn.Date</p>
                    </div>
                    <div class="col-3">
                        <h6 class="fw-bolder">Salida:</h6>
                        <p id="ckeckout-date-@item.Id" class="card-text">@(item.CheckOut != null ? item.CheckOut.Date : "No presenta")</p>
                    </div>
                    <div class="col-3">
                        <h6 class="fw-bolder">Duración:</h6>
                        <p id="total-worked-@item.Id" class="card-text">@(item.TotalWorked ?? "N/A")</p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Open and Close Modal  -->
<div class="modal fade" id="recognition-modal" data-action="open" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="camera-modal-title" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="camera-modal-title">Abrir sesión</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container text-center">
                    <div class="row">
                        <div class="col-md-12">
                            <p id="faceid-helper" class="text-sm-start">
                                Presion el boton 'Abrir' y mantenga su posición durante 3 segundos
                            </p>
                        </div>
                        <div class="col-md-12">
                            <div style="position: relative; display: inline-block;">
                                <video id="video" width="400" height="300" autoplay muted"></video>
                                <canvas id="snapshot" style="position: relative; display: none;"></canvas>
                                <div id="countdown-overlay"></div>
                                <div id="loader-overlay" class="d-flex justify-content-center align-items-center">
                                    <div class="spinner-border text-white" style="width: 4rem; height: 4rem;">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="snapshotAgain()">Reintentar</button>
                <div id="open-session-button-container">
                    <button onclick="startCountdown()" id="save-session-button" type="button" class="btn btn-primary" disabled>
                        Preparando...
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detail-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="detail-modal-title" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="camera-modal-title">Detalle</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6 class="fw-bold">ID de Sesión</h6>
                            <p id="session-id"></p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold">ID de Empleado</h6>
                            <p id="employee-id"></p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <h6 class="fw-bold">Estado</h6>
                            <p id="session-status"></p>
                        </div>
                        <div class="col-md-4">
                            <h6 class="fw-bold">Total Trabajado</h6>
                            <p id="total-worked"></p>
                        </div>
                    </div>
                    <hr>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h5 class="fw-bold">Entrada</h5>
                            <ul class="list-group">
                                <li class="list-group-item"><b>Método:</b> <span id="checkin-method"></span></li>
                                <li class="list-group-item"><b>Dispositivo:</b> <span id="checkin-device"></span></li>
                                <li class="list-group-item"><b>Fecha:</b> <span id="checkin-date"></span></li>
                                <li class="list-group-item"><b>Notas:</b> <span id="checkin-notes"></span></li>
                                <li class="list-group-item"><b>Foto:</b> <img id="checkin-photo" src="" alt="Foto entrada" class="img-thumbnail" style="max-width:100px;" /></li>
                                <li class="list-group-item">
                                    <b>Ubicación:</b>
                                    <ul>
                                        <li><b>Latitud:</b> <span id="checkin-lat"></span></li>
                                        <li><b>Longitud:</b> <span id="checkin-lng"></span></li>
                                        <li><b>IP:</b> <span id="checkin-ip"></span></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5 class="fw-bold">Salida</h5>
                            <ul class="list-group">
                                <li class="list-group-item"><b>Método:</b> <span id="checkout-method"></span></li>
                                <li class="list-group-item"><b>Dispositivo:</b> <span id="checkout-device"></span></li>
                                <li class="list-group-item"><b>Fecha:</b> <span id="checkout-date"></span></li>
                                <li class="list-group-item"><b>Notas:</b> <span id="checkout-notes"></span></li>
                                <li class="list-group-item"><b>Foto:</b> <img id="checkout-photo" src="" alt="Foto salida" class="img-thumbnail" style="max-width:100px;" /></li>
                                <li class="list-group-item">
                                    <b>Ubicación:</b>
                                    <ul>
                                        <li><b>Latitud:</b> <span id="checkout-lat"></span></li>
                                        <li><b>Longitud:</b> <span id="checkout-lng"></span></li>
                                        <li><b>IP:</b> <span id="checkout-ip"></span></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script src="~/js/location.js"></script>
    <script src="~/js/work.session.js"></script>
}
